
version: "3.9"

services:
  # MongoDB Primary (server-a)
  mongo-primary:
    image: mongo:8.2
    hostname: mongo-primary
    # Phase 1: Sans auth pour init. Phase 2: Décommenter --keyFile
    # Ajout de --quiet pour réduire les logs réseau (Connection ended, etc.)
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--quiet"]
    # command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/etc/mongo-keyfile", "--quiet"]
    environment:
      MONGO_INITDB_DATABASE: art_retrainer
    volumes:
      - mongo_primary_data:/data/db
    configs:
      - source: mongo_keyfile
        target: /etc/mongo-keyfile
        uid: "999"
        gid: "999"
        mode: 0400
    networks:
      - internal
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == server-b
      restart_policy:
        condition: on-failure
        delay: 5s

  # MongoDB Secondary 1 (server-b)
  mongo-secondary1:
    image: mongo:8.2
    hostname: mongo-secondary1
    # Phase 1: Sans auth pour init. Phase 2: Décommenter --keyFile
    # Ajout de --quiet pour réduire les logs réseau (Connection ended, etc.)
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--quiet"]
    # command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/etc/mongo-keyfile", "--quiet"]
    volumes:
      - mongo_secondary1_data:/data/db
    configs:
      - source: mongo_keyfile
        target: /etc/mongo-keyfile
        uid: "999"
        gid: "999"
        mode: 0400
    networks:
      - internal
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == server-c
      restart_policy:
        condition: on-failure
        delay: 5s

  # MongoDB Secondary 2 (server-c)
  mongo-secondary2:
    image: mongo:8.2
    hostname: mongo-secondary2
    # Phase 1: Sans auth pour init. Phase 2: Décommenter --keyFile
    # Ajout de --quiet pour réduire les logs réseau (Connection ended, etc.)
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--quiet"]
    # command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--keyFile", "/etc/mongo-keyfile", "--quiet"]
    volumes:
      - mongo_secondary2_data:/data/db
    configs:
      - source: mongo_keyfile
        target: /etc/mongo-keyfile
        uid: "999"
        gid: "999"
        mode: 0400
    networks:
      - internal
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.hostname == server-d
      restart_policy:
        condition: on-failure
        delay: 5s

  # MongoDB Replica Set Initializer (runs once)
  mongo-init:
    image: mongo:8.2
    entrypoint: ["bash", "-c"]
    command:
      - |
        echo "Waiting for MongoDB instances to be reachable..."
        
        # Wait for mongo-primary to be available (up to 2 minutes)
        for i in $$(seq 1 24); do
          if mongosh --host mongo-primary:27017 --eval "db.adminCommand('ping')" --quiet 2>/dev/null; then
            echo "mongo-primary is reachable!"
            break
          fi
          echo "Attempt $$i/24: mongo-primary not ready, waiting 5s..."
          sleep 5
        done
        
        # Wait for secondaries
        for h in mongo-secondary1 mongo-secondary2; do
          for j in $$(seq 1 12); do
            if mongosh --host $$h:27017 --eval "db.adminCommand('ping')" --quiet 2>/dev/null; then
              echo "$$h is reachable!"
              break
            fi
            echo "Waiting for $$h... ($$j/12)"
            sleep 5
          done
        done
        
        echo "Initializing replica set..."
        mongosh --host mongo-primary:27017 --eval '
          try {
            rs.status();
            print("Replica set already initialized");
          } catch(e) {
            print("Initializing replica set...");
            rs.initiate({
              _id: "rs0",
              members: [
                { _id: 0, host: "mongo-primary:27017", priority: 2 },
                { _id: 1, host: "mongo-secondary1:27017", priority: 1 },
                { _id: 2, host: "mongo-secondary2:27017", priority: 1 }
              ]
            });
            print("Replica set initialized");
          }
        '
        
        echo "Waiting for primary election..."
        sleep 10
        
        echo "Replica set status:"
        mongosh --host mongo-primary:27017 --eval "rs.status()"
    networks:
      - internal
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3
      placement:
        constraints:
          - node.hostname == server-a

# MongoDB Admin UI (connects to replica set)
  mongo-express:
    image: mongo-express:1-20-alpine3.19
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://mongo-primary:27017,mongo-secondary1:27017,mongo-secondary2:27017/?replicaSet=rs0
      - ME_CONFIG_BASICAUTH_USERNAME=${MONGO_EXPRESS_USER:-gildas}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_EXPRESS_PASSWORD:-admin123}
    networks:
      - proxy
      - internal
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.label != gpu
      labels:
        # Activer Traefik
        - "traefik.enable=true"
        
        # Définir le port du service mongo-express
        - "traefik.http.services.mongo-express.loadbalancer.server.port=8081"
        
        # Middleware: Autoriser uniquement les IPs locales
        - "traefik.http.middlewares.mongo-local-only.ipallowlist.sourcerange=127.0.0.1/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
        
        # Router HTTPS (principal) - MongoDB Admin
        - "traefik.http.routers.mongo-express.rule=Host(`mongo.methodinfo.fr`)"
        - "traefik.http.routers.mongo-express.entrypoints=websecure"
        - "traefik.http.routers.mongo-express.tls.certresolver=letsencrypt"
        - "traefik.http.routers.mongo-express.middlewares=mongo-local-only,global@file"
        
        # Router HTTP (redirige vers HTTPS)
        - "traefik.http.routers.mongo-express-http.rule=Host(`mongo.methodinfo.fr`)"
        - "traefik.http.routers.mongo-express-http.entrypoints=web"
        - "traefik.http.routers.mongo-express-http.middlewares=redirect-to-https@file"
        - "traefik.http.routers.mongo-express-http.service=noop@internal"
      restart_policy:
        condition: on-failure


configs:
  mongo_keyfile:
    external: true

volumes:
  mongo_primary_data:
  mongo_secondary1_data:
  mongo_secondary2_data:

networks:
  internal:
    driver: overlay
    attachable: true
  proxy:
    external: true